= Chapter 5

== 5.1 Couchbase cluster using services

Follow the steps in blog: https://blog.couchbase.com/couchbase-cluster-docker/

== 5.2 Persistent Storage with Docker containers

=== Implicit per-container storage

. Terminal1: Run Couchbase container: `docker container run -d --name db arungupta/couchbase`
. Check volume mounts: `docker inspect --format '{{json .Mounts }}' db  | jq`
.. Show `/opt/couchbase/var` is mapped to the implicit storage
. Check the mounted volume: `docker container inspect --format='{{range .Mounts}}{{.Source}}{{end}}' db`
. Terminal2: Log into Docker for Mac VM:
+
```
docker run -it --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh
```
+
.. `debian` image has `nsenter`
.. `--pid=host` means enter the process space of the VM running Docker For Mac
.. `sh` says to run a shell there
+

. Show `ls <volume-dir>`
. Terminal1: Stop container: `docker container stop db`
. Remove container, including the volume: `docker container rm -v db`
. Terminal2: Show that the volume does not exist any more

=== Explicit per-container storage

. Create a new volume: `docker volume create my_couchbase`
. Check the list of volumes: `docker volume ls`
. Get more details about the volume: `docker volume inspect my_couchbase`
. Create a Couchbase container using this volume:
+
```
docker container run \
  -d \
  --name db \
  -p 8091-8093:8091-8093 \
  -v my_couchbase:/opt/couchbase/var \
  arungupta/couchbase
```
+
. Check the volume mount again: `docker inspect --format '{{json .Mounts }}' db  | jq`
.. Show how the newly created volume is used here
. Terminate the container: `docker container rm -f db`
. Delete the volume explicitly: `docker volume rm my_couchbase`

=== Per-host storage

. Run Couchbase container
+
```
docker container run \
  -d \
  --name db \
  -p 8091-8093:8091-8093 \
  -v ~/couchbase:/opt/couchbase/var \
  arungupta/couchbase
```
+
. Check volume mounts: `docker inspect --format '{{json .Mounts }}' db  | jq`
.. Show `/opt/couchbase/var` is mapped to the explicit directory
. Show data in `~/couchbase`
. Login to Couchbase Web Console at http://localhost:8091
. Create a new bucket
. Kill the container: `docker container rm -f db`
. Restart the container using previous command
. Access Couchbase Web Console and show that the bucket still exists

== 5.3 Docker Volume Plugin

Talk through slides

https://blog.couchbase.com/stateful-docker-containers-portworx-couchbase/

Setup EC2 instance:

. Ubuntu 14.04, `m3.medium`
.. Add `8091` to inbound rules
. Login to EC2 instance: `ssh -i ~/.ssh/arun-cb-west1.pem ubuntu@<public-ip>`
. Update: `sudo apt-get update`
. Install Docker: `curl -sSL https://get.docker.com/ | sh`
. Enable non-root access: `sudo usermod -aG docker ubuntu`
. Logout and log back in

Follow steps from the blog

== 5.4 Monitoring Docker using CLI

=== Docker CLI

. `docker container stats` - You can use the `docker stats` command to live stream a containerâ€™s runtime metrics. The command supports CPU, memory usage, memory limit, and network IO metrics.
. See the list of running containers using `docker container ls` and show stats for one container only
. `docker container stats <name>`
. `docker stats --format "{{.Container}}: {{.CPUPerc}}"`
. `docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"`
. `docker container stats --no-stream`

=== Docker Remote API

. `curl --unix-socket /var/run/docker.sock http://docker/containers/<name>/stats`

=== Events

. `docker system events`
. In a different tab, kill existing container using `docker container rm -f <name>`
. Show the list of events
. Start a new container
. Show the list of events

== 5.4 Monitoring using Prometheus and cAdvisor

=== Prometheus endpoint

=== cAdvisor

. Run `cAdvisor`
+
```
docker run \
  -d \
  --name=cadvisor \
  -p 8080:8080 \
  --volume=/var/run:/var/run:rw \
  --volume=/sys:/sys:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  google/cadvisor:latest
```
+
. Show dashboard at http://localhost:8080
.. Explain CPU and Memory isolation
.. Explain CPU, Memory, Network, Filesystem usage
. Start Couchbase container:
+
```
docker run \
  -d \
  --name db \
  -p 8091-8093:8091-8093 \
  arungupta/couchbase
```
+
. Show dashboard again and dig into the sub-container
. Connect CBQ: 
+
```
docker run \
  -it \
  --link db:db \
  arungupta/couchbase \
  cbq \
  -u Administrator \
  -p password \
  --engine http://db:8093
```
+
. Show Couchbase Web Console at http://localhost:8091
. Create a new bucket `docker`
. Create primary index in Query tab: `create primary index on docker;`
. Select documents from the bucket `select * from docker;`
. Show dashboard again

== 5.4 Monitoring using Sysdig

=== DUCP

=== Sysdig



